<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title>Quran WebView</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" rel="stylesheet">
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // State variables
      let currentPage = 1;
      const totalPages = 604;
      let singlePageMode = window.innerWidth < 768;
      let fullscreenActive = false;
      const preloadCache = new Map();

      // Fullscreen handling
      async function toggleFullscreen() {
        try {
          if (!fullscreenActive) {
            // Try standard API first
            if (document.documentElement.requestFullscreen) {
              await document.documentElement.requestFullscreen();
            } 
            // Fallback for Safari
            else if (document.documentElement.webkitRequestFullscreen) {
              await document.documentElement.webkitRequestFullscreen();
            }
            // Fallback for IE/Edge
            else if (document.documentElement.msRequestFullscreen) {
              await document.documentElement.msRequestFullscreen();
            }
            fullscreenActive = true;
          } else {
            // Exit fullscreen
            if (document.exitFullscreen) {
              await document.exitFullscreen();
            } else if (document.webkitExitFullscreen) {
              await document.webkitExitFullscreen();
            } else if (document.msExitFullscreen) {
              await document.msExitFullscreen();
            }
            fullscreenActive = false;
          }
        } catch (err) {
          console.error("Fullscreen error:", err);
          // Fallback CSS fullscreen
          const container = document.querySelector('.quran-container');
          if (!fullscreenActive) {
            container.classList.add('fixed', 'inset-0', 'z-50', 'bg-white', 'p-0', 'm-0');
            container.style.maxHeight = '100vh';
            fullscreenActive = true;
          } else {
            container.classList.remove('fixed', 'inset-0', 'z-50', 'bg-white', 'p-0', 'm-0');
            container.style.maxHeight = '';
            fullscreenActive = false;
          }
        }
        updateButtonStyles();
      }

      // Listen for fullscreen changes
      ['fullscreenchange', 'webkitfullscreenchange', 'msfullscreenchange'].forEach(event => {
        document.addEventListener(event, () => {
          fullscreenActive = !!(
            document.fullscreenElement || 
            document.webkitFullscreenElement || 
            document.msFullscreenElement
          );
          updateButtonStyles();
        });
      });

      // Page transition functions
      async function updatePages() {
        const leftPage = document.getElementById('page-left');
        const rightPage = document.getElementById('page-right');
        const pageRightElement = document.getElementById('page-right-container');

        // Fade out both pages simultaneously
        leftPage.classList.add('opacity-0');
        if (!singlePageMode) rightPage.classList.add('opacity-0');
        await new Promise(resolve => setTimeout(resolve, 100));

        // Update content
        leftPage.src = `https://media.qurankemenag.net/khat2/QK_${String(currentPage).padStart(3, '0')}.webp`;
        document.getElementById('page-number').value = singlePageMode ? `${currentPage}` : `${currentPage} - ${currentPage + 1}`;
        document.getElementById('mobile-page-number').value = `${currentPage}`;

        if (singlePageMode) {
          pageRightElement.style.display = 'none';
        } else {
          pageRightElement.style.display = 'block';
          rightPage.src = `https://media.qurankemenag.net/khat2/QK_${String(currentPage + 1).padStart(3, '0')}.webp`;
        }

        // Fade in both pages simultaneously
        leftPage.classList.remove('opacity-0');
        if (!singlePageMode) rightPage.classList.remove('opacity-0');
        preloadPages();
      }

      // Preloading functions
      function preloadImage(page) {
        if (!preloadCache.has(page) && page > 0 && page <= totalPages) {
          const img = new Image();
          img.src = `https://media.qurankemenag.net/khat2/QK_${String(page).padStart(3, '0')}.webp`;
          preloadCache.set(page, img);
        }
      }

      function preloadPages() {
        const pagesToPreload = singlePageMode
          ? [currentPage - 1, currentPage + 1]
          : [currentPage - 2, currentPage - 1, currentPage + 1, currentPage + 2];
        pagesToPreload.forEach(page => preloadImage(page));
      }

      // UI update functions
      function updateButtonStyles() {
        // Update view mode buttons
        document.getElementById('single-page-button').classList.toggle('bg-green-900', singlePageMode);
        document.getElementById('single-page-button').classList.toggle('bg-green-700', !singlePageMode);
        document.getElementById('two-page-button').classList.toggle('bg-green-900', !singlePageMode);
        document.getElementById('two-page-button').classList.toggle('bg-green-700', singlePageMode);
        
        // Update fullscreen button
        document.getElementById('fullscreen-button').classList.toggle('bg-green-900', fullscreenActive);
        document.getElementById('fullscreen-button').classList.toggle('bg-green-700', !fullscreenActive);
        
        // Update fullscreen icon
        const icon = document.querySelector('#fullscreen-button i');
        icon.className = fullscreenActive ? 'fas fa-compress' : 'fas fa-expand';
        
        // Disable two-page mode on mobile
        const twoPageButton = document.getElementById('two-page-button');
        if (window.innerWidth < 768) {
          twoPageButton.disabled = true;
          twoPageButton.classList.add('opacity-50', 'cursor-not-allowed');
        } else {
          twoPageButton.disabled = false;
          twoPageButton.classList.remove('opacity-50', 'cursor-not-allowed');
        }
      }

      // Navigation functions
      async function navigate(direction) {
        if (direction === 'next' && currentPage > 1) {
          currentPage -= singlePageMode ? 1 : 2;
        } else if (direction === 'prev' && currentPage < totalPages - 1) {
          currentPage += singlePageMode ? 1 : 2;
        }
        await updatePages();
      }

      // Event handlers
      function handleResize() {
        const isMobile = window.innerWidth < 768;
        if (isMobile && !singlePageMode) {
          singlePageMode = true;
          updatePages();
        }
        updateButtonStyles();
      }

      // Initialize
      function init() {
        // Set up event listeners
        document.getElementById('page-number').addEventListener('keydown', function (e) {
          if (e.key === 'Enter') {
            const page = parseInt(this.value);
            if (page > 0 && page <= totalPages) {
              currentPage = page % 2 === 0 && !singlePageMode ? page - 1 : page;
              updatePages();
            } else {
              this.value = singlePageMode ? `${currentPage}` : `${currentPage} - ${currentPage + 1}`;
            }
          }
        });

        document.addEventListener('keydown', (e) => {
          if (e.key === 'ArrowLeft') navigate('prev');
          else if (e.key === 'ArrowRight') navigate('next');
        });

        document.getElementById('next-icon').addEventListener('click', () => navigate('next'));
        document.getElementById('prev-icon').addEventListener('click', () => navigate('prev'));
        document.getElementById('fullscreen-button').addEventListener('click', toggleFullscreen);
        document.getElementById('single-page-button').addEventListener('click', () => {
          singlePageMode = true;
          updatePages();
          updateButtonStyles();
        });
        document.getElementById('two-page-button').addEventListener('click', () => {
          singlePageMode = false;
          currentPage = currentPage % 2 === 0 ? currentPage - 1 : currentPage;
          updatePages();
          updateButtonStyles();
        });
        window.addEventListener('resize', handleResize);

        // Mobile controls
        document.getElementById('mobile-next-icon').addEventListener('click', () => navigate('next'));
        document.getElementById('mobile-prev-icon').addEventListener('click', () => navigate('prev'));
        document.getElementById('mobile-page-number').addEventListener('keydown', (e) => {
          if (e.key === 'Enter') {
            const page = parseInt(this.value);
            if (page > 0 && page <= totalPages) {
              currentPage = page;
              updatePages();
            } else {
              this.value = currentPage;
            }
          }
        });

        // Initial setup
        updatePages();
        updateButtonStyles();
      }

      init();
    });
  </script>
</head>
<body class="bg-gray-100">
  <!-- Header -->
  <div class="bg-green-700 text-white py-4">
    <div class="container mx-auto flex justify-between items-center px-4">
      <a href="#" onclick="location.reload();" class="text-xl font-bold">Qur'an WebView</a>  
      <div class="flex items-center space-x-2 md:space-x-4">
        <span class="hidden sm:inline">
          Page: <input class="bg-white w-20 py-2 text-black text-center rounded" id="page-number" type="text" value="1 - 2"/>
        </span>
        <button class="bg-green-700 text-white px-3 py-2 md:px-4 md:py-2 rounded hover:bg-green-600" id="single-page-button" title="Single Page">
          <i class="fa-solid fa-file"></i>
        </button>
        <button class="bg-green-700 text-white px-3 py-2 md:px-4 md:py-2 rounded hover:bg-green-600" id="two-page-button" title="Two Pages">
          <i class="fa-solid fa-book-open"></i>
        </button>
        <button class="bg-green-700 text-white px-3 py-2 md:px-4 md:py-2 rounded hover:bg-green-600" id="fullscreen-button">
          <i class="fas fa-expand"></i>
        </button>
      </div>
    </div>
  </div>
  
  <!-- Main Content -->
  <div class="quran-container container mx-auto py-4 md:py-8 relative px-4">
    <div class="flex justify-center flex-row-reverse">
      <!-- Left Page -->
      <div class="bg-white border border-gray-300 p-2 md:p-4">
        <img alt="Quran page" 
             class="w-full max-h-[80vh] md:max-h-[90vh] transition-opacity duration-100 ease-linear opacity-100" 
             id="page-left" 
             src="https://media.qurankemenag.net/khat2/QK_001.webp"/>
      </div>
      
      <!-- Right Page -->
      <div class="bg-white border border-gray-300 p-2 md:p-4 ml-2 md:ml-4" id="page-right-container">
        <img alt="Quran page" 
             class="w-full max-h-[80vh] md:max-h-[90vh] transition-opacity duration-100 ease-linear opacity-100" 
             id="page-right" 
             src="https://media.qurankemenag.net/khat2/QK_002.webp"/>
      </div>
    </div>
    
    <!-- Desktop Navigation -->
    <div class="hidden lg:flex fixed top-1/2 -translate-y-1/2 left-10 z-10">
      <i class="fa-solid fa-circle-chevron-left text-5xl text-gray-300 cursor-pointer hover:text-green-700" id="prev-icon"></i>
    </div>
    <div class="hidden lg:flex fixed top-1/2 -translate-y-1/2 right-10 z-10">
      <i class="fa-solid fa-circle-chevron-right text-5xl text-gray-300 cursor-pointer hover:text-green-700" id="next-icon"></i>
    </div>
    
    <!-- Mobile Navigation -->
    <div class="md:hidden flex justify-center items-center mt-4 space-x-4">
      <i class="fa-solid fa-circle-chevron-left text-4xl text-gray-600 cursor-pointer hover:text-green-700" id="mobile-prev-icon"></i>
      <div class="flex items-center">
        <span class="text-gray-700 mr-2">Page:</span>
        <input class="bg-white w-16 py-2 text-black text-center rounded border border-gray-300" id="mobile-page-number" type="text" value="1"/>
      </div>
      <i class="fa-solid fa-circle-chevron-right text-4xl text-gray-600 cursor-pointer hover:text-green-700" id="mobile-next-icon"></i>
    </div>
  </div>
  
  <!-- Footer -->
  <footer class="bg-gray-800 text-white py-4">
    <div class="container mx-auto text-center px-4">
      <p class="text-sm">This Qur'an page is sourced from <a href="https://quran.kemenag.go.id/" target="_blank" class="text-green-500 hover:underline">Qur'an Kemenag</a></p>
    </div>
  </footer>
</body>
</html>